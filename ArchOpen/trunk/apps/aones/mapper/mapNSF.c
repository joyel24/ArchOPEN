#include "datatypes.h"
#include "unes_mapper.h"
#include "unes_io.h"
#include "unes.h"
#include "unes_ppu.h"

uint8 wram1[0x2000];
uint8 wram2[0x8000];
uint8 chip_type;

/////////////////////////////////////////////////////////////////////
// Mapper NSF - private mapper number = 12 (decimal)

static void mapNSF_BankSwitch(uint8 num, uint8 bank)
{
	uint32 i;
	uint32 load_start = (mmc_getinfo()->var.prg_beg[0x8] | (mmc_getinfo()->var.prg_beg[0x9] << 8)) & 0x0FFF;
	if((num == 6) || (num == 7))
	{
		for(i = 0; i < 0x1000; i++)
		{
			int32 adr = 0x1000 * bank + i + 0x80 - load_start;
			if(adr < 0)
			{
				wram1[0x1000*(num&1)+i] = 0;
			}
			else
			{
				wram1[0x1000*(num&1)+i] = mmc_getinfo()->var.prg_beg[adr];
			}
		}
	}
	else if((num >= 8) && (num <= 14))
	{
		for(i = 0; i < 0x1000; i++)
		{
			int32 adr = 0x1000 * bank + i + 0x80 - load_start;
			if(adr < 0)
			{
				wram2[0x1000*(num&7)+i] = 0;
			}
			else
			{
				wram2[0x1000*(num&7)+i] = mmc_getinfo()->var.prg_beg[adr];
			}
		}
	}
	else if(num == 15)
	{
		uint32 adr_max;
		if(chip_type & 4)
		{
			adr_max = 0xE40;
		}
		else
		{
			adr_max = 0xFFA;
		}
		for(i = 0; i < adr_max; i++)
		{
			int32 adr = 0x1000 * bank + i + 0x80 - load_start;
			if(adr < 0)
			{
				wram2[0x1000*(num&7)+i] = 0;
			}
			else
			{
				wram2[0x1000*(num&7)+i] = mmc_getinfo()->var.prg_beg[adr];
			}
		}
	}
}

static void mapNSF_LoadPlayer()
{
	// Load Player (thanx Chris Covell)
	uint32 i;
	uint8 play_prg1[0x1C0] =
	    {
	        0x78,0xd8,0xa2,0xff,0x9a,0xad,0x02,0x20,0x10,0xfb,0xa9,0x00,0xaa,0x95,0x00,0x9d,
	        0x00,0x01,0x9d,0x00,0x02,0x9d,0x00,0x03,0x9d,0x00,0x04,0x9d,0x00,0x05,0x9d,0x00,
	        0x06,0x9d,0x00,0x07,0xe8,0xd0,0xe6,0xa9,0x80,0x8d,0x00,0x20,0xa9,0x00,0x8d,0x01,
	        0x20,0xa9,0x00,0x8d,0x06,0x20,0x8d,0x06,0x20,0xaa,0x8d,0x07,0x20,0xe8,0xe0,0x10,
	        0xd0,0xf8,0xa9,0x01,0x8d,0x06,0x20,0xa9,0x00,0x8d,0x06,0x20,0xa2,0x00,0xa0,0x00,
	        0xbd,0x70,0x7f,0x8d,0x07,0x20,0xe8,0xc8,0xc0,0x08,0xd0,0xf4,0xa0,0x00,0x8c,0x07,
	        0x20,0x8c,0x07,0x20,0x8c,0x07,0x20,0x8c,0x07,0x20,0x8c,0x07,0x20,0x8c,0x07,0x20,
	        0x8c,0x07,0x20,0x8c,0x07,0x20,0xe0,0x80,0xd0,0xd6,0xa9,0x3f,0x8d,0x06,0x20,0xa9,
	        0x00,0x8d,0x06,0x20,0xa9,0x0e,0x8d,0x07,0x20,0xa9,0x30,0x8d,0x07,0x20,0xa9,0x00,
	        0x8d,0xf1,0x7f,0xa9,0x0e,0x8d,0x01,0x20,0xa9,0x00,0x8d,0xf1,0x7f,0x20,0x00,0x80,
	        0xa9,0x01,0x8d,0xf0,0x7f,0x20,0x4d,0x7f,0x29,0x10,0xf0,0xf9,0xee,0xf1,0x7f,0xa9,
	        0xff,0xcd,0xf1,0x7f,0xd0,0x05,0xa9,0x00,0x8d,0xf1,0x7f,0xa9,0x00,0x8d,0xf0,0x7f,
	        0xad,0xf1,0x7f,0x20,0x00,0x80,0xa9,0x01,0x8d,0xf0,0x7f,0x4c,0xe5,0x7e,0x48,0x8a,
#if 1
	        0x48,0x98,0x48,0xa9,0x20,0x8d,0x06,0x20,/**/0xa9,0x41,/**/0x8d,0x06,0x20,0xad,0xf1,0x7f,0x4a,0x4a, //gli: changed pos of current song display
	        0x4a,0x4a,0x09,0x10,0x8d,0x07,0x20,0xad,0xf1,0x7f,0x29,0x0f,0x09,0x10,0x8d,0x07,
	        0x20,0xa9,0x00,/*0x8d,0x06,0x20,0x8d,0x06,0x20*//**/0xea,0xea,0xea,0xea,/**/0x8d,0x05,0x20,0x8d,0x05,0x20,0xad, //gli: I needed 2 bytes :)
#else
	        0x48,0x98,0x48,0xa9,0x20,0x8d,0x06,0x20,0x8d,0x06,0x20,0xad,0xf1,0x7f,0x4a,0x4a,
	        0x4a,0x4a,0x09,0x10,0x8d,0x07,0x20,0xad,0xf1,0x7f,0x29,0x0f,0x09,0x10,0x8d,0x07,
	        0x20,0xa9,0x00,0x8d,0x06,0x20,0x8d,0x06,0x20,0x8d,0x05,0x20,0x8d,0x05,0x20,0xad,
#endif
	        0xf0,0x7f,0xf0,0x03,0x20,0x00,0x80,0x68,0xa8,0x68,0xaa,0x68,0x40,0xa0,0x08,0xa2,
	        0x01,0x8e,0x16,0x40,0xca,0x8e,0x16,0x40,0xad,0x16,0x40,0x6a,0x8a,0x2a,0xaa,0x88,
	        0xd0,0xf6,0xcd,0xf2,0x7f,0xf0,0x04,0x8d,0xf2,0x7f,0x60,0xa9,0x00,0x60,0x00,0x00,
	        0x38,0x4c,0xc6,0xc6,0xc6,0x64,0x38,0x00,0x18,0x38,0x18,0x18,0x18,0x18,0x7e,0x00,
	        0x7c,0xc6,0x0e,0x3c,0x78,0xe0,0xfe,0x00,0x7e,0x0c,0x18,0x3c,0x06,0xc6,0x7c,0x00,
	        0x1c,0x3c,0x6c,0xcc,0xfe,0x0c,0x0c,0x00,0xfc,0xc0,0xfc,0x06,0x06,0xc6,0x7c,0x00,
	        0x3c,0x60,0xc0,0xfc,0xc6,0xc6,0x7c,0x00,0xfe,0xc6,0x0c,0x18,0x30,0x30,0x30,0x00,
	        0x7c,0xc6,0xc6,0x7c,0xc6,0xc6,0x7c,0x00,0x7c,0xc6,0xc6,0x7e,0x06,0x0c,0x78,0x00,
	        0x38,0x6c,0xc6,0xc6,0xfe,0xc6,0xc6,0x00,0xfc,0xc6,0xc6,0xfc,0xc6,0xc6,0xfc,0x00,
	        0x3c,0x66,0xc0,0xc0,0xc0,0x66,0x3c,0x00,0xf8,0xcc,0xc6,0xc6,0xc6,0xcc,0xf8,0x00,
	        0xfe,0xc0,0xc0,0xfc,0xc0,0xc0,0xfe,0x00,0xfe,0xc0,0xc0,0xfc,0xc0,0xc0,0xc0,0x00,
	        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0e,0x7f,0x40,0x7e,0x0e,0x7f
	    };

	uint8 play_prg2[0x1C0] =
	    {
	        0x78,0xd8,0xa2,0xff,0x9a,0xad,0x02,0x20,0x10,0xfb,0xa9,0x00,0xaa,0x95,0x00,0x9d,
	        0x00,0x01,0x9d,0x00,0x02,0x9d,0x00,0x03,0x9d,0x00,0x04,0x9d,0x00,0x05,0x9d,0x00,
	        0x06,0x9d,0x00,0x07,0xe8,0xd0,0xe6,0xa9,0x80,0x8d,0x00,0x20,0xa9,0x00,0x8d,0x01,
	        0x20,0xa9,0x00,0x8d,0x06,0x20,0x8d,0x06,0x20,0xaa,0x8d,0x07,0x20,0xe8,0xe0,0x10,
	        0xd0,0xf8,0xa9,0x01,0x8d,0x06,0x20,0xa9,0x00,0x8d,0x06,0x20,0xa2,0x00,0xa0,0x00,
	        0xbd,0x70,0xff,0x8d,0x07,0x20,0xe8,0xc8,0xc0,0x08,0xd0,0xf4,0xa0,0x00,0x8c,0x07,
	        0x20,0x8c,0x07,0x20,0x8c,0x07,0x20,0x8c,0x07,0x20,0x8c,0x07,0x20,0x8c,0x07,0x20,
	        0x8c,0x07,0x20,0x8c,0x07,0x20,0xe0,0x80,0xd0,0xd6,0xa9,0x3f,0x8d,0x06,0x20,0xa9,
	        0x00,0x8d,0x06,0x20,0xa9,0x0e,0x8d,0x07,0x20,0xa9,0x30,0x8d,0x07,0x20,0xa9,0x00,
	        0x8d,0xf1,0xff,0xa9,0x0e,0x8d,0x01,0x20,0xa9,0x00,0x8d,0xf1,0xff,0x20,0x00,0x80,
	        0xa9,0x01,0x8d,0xf0,0xff,0x20,0x4d,0xff,0x29,0x10,0xf0,0xf9,0xee,0xf1,0xff,0xa9,
	        0xff,0xcd,0xf1,0xff,0xd0,0x05,0xa9,0x00,0x8d,0xf1,0xff,0xa9,0x00,0x8d,0xf0,0xff,
	        0xad,0xf1,0xff,0x20,0x00,0x80,0xa9,0x01,0x8d,0xf0,0xff,0x4c,0xe5,0xfe,0x48,0x8a,
	        0x48,0x98,0x48,0xa9,0x20,0x8d,0x06,0x20,0x8d,0x06,0x20,0xad,0xf1,0xff,0x4a,0x4a,
	        0x4a,0x4a,0x09,0x10,0x8d,0x07,0x20,0xad,0xf1,0xff,0x29,0x0f,0x09,0x10,0x8d,0x07,
	        0x20,0xa9,0x00,0x8d,0x06,0x20,0x8d,0x06,0x20,0x8d,0x05,0x20,0x8d,0x05,0x20,0xad,
	        0xf0,0xff,0xf0,0x03,0x20,0x00,0x80,0x68,0xa8,0x68,0xaa,0x68,0x40,0xa0,0x08,0xa2,
	        0x01,0x8e,0x16,0x40,0xca,0x8e,0x16,0x40,0xad,0x16,0x40,0x6a,0x8a,0x2a,0xaa,0x88,
	        0xd0,0xf6,0xcd,0xf2,0xff,0xf0,0x04,0x8d,0xf2,0xff,0x60,0xa9,0x00,0x60,0x00,0x00,
	        0x38,0x4c,0xc6,0xc6,0xc6,0x64,0x38,0x00,0x18,0x38,0x18,0x18,0x18,0x18,0x7e,0x00,
	        0x7c,0xc6,0x0e,0x3c,0x78,0xe0,0xfe,0x00,0x7e,0x0c,0x18,0x3c,0x06,0xc6,0x7c,0x00,
	        0x1c,0x3c,0x6c,0xcc,0xfe,0x0c,0x0c,0x00,0xfc,0xc0,0xfc,0x06,0x06,0xc6,0x7c,0x00,
	        0x3c,0x60,0xc0,0xfc,0xc6,0xc6,0x7c,0x00,0xfe,0xc6,0x0c,0x18,0x30,0x30,0x30,0x00,
	        0x7c,0xc6,0xc6,0x7c,0xc6,0xc6,0x7c,0x00,0x7c,0xc6,0xc6,0x7e,0x06,0x0c,0x78,0x00,
	        0x38,0x6c,0xc6,0xc6,0xfe,0xc6,0xc6,0x00,0xfc,0xc6,0xc6,0xfc,0xc6,0xc6,0xfc,0x00,
	        0x3c,0x66,0xc0,0xc0,0xc0,0x66,0x3c,0x00,0xf8,0xcc,0xc6,0xc6,0xc6,0xcc,0xf8,0x00,
	        0xfe,0xc0,0xc0,0xfc,0xc0,0xc0,0xfe,0x00,0xfe,0xc0,0xc0,0xfc,0xc0,0xc0,0xc0,0x00,
	        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0e,0xff,0x40,0xfe,0x0e,0xff
	    };

	if(chip_type & 4)
	{
		// $FE40 - $FFFF (FDS)
		for(i = 0; i < 0x1C0; i++)
		{
			wram2[0x7E40+i] = play_prg2[i];
		}
		wram2[0x7E40+0x09E] = mmc_getinfo()->var.prg_beg[0xA]; // INIT_ADR
		wram2[0x7E40+0x09F] = mmc_getinfo()->var.prg_beg[0xB];
		wram2[0x7E40+0x0C4] = mmc_getinfo()->var.prg_beg[0xA]; // INIT_ADR
		wram2[0x7E40+0x0C5] = mmc_getinfo()->var.prg_beg[0xB];
		wram2[0x7E40+0x105] = mmc_getinfo()->var.prg_beg[0xC]; // PLAY_ADR
		wram2[0x7E40+0x106] = mmc_getinfo()->var.prg_beg[0xD];
		wram2[0x7E40+0x0B0] = mmc_getinfo()->var.prg_beg[0x6]; // MAX_SONG
	}
	else
	{
        // $7E40 - $7FFF (non FDS)
		for(i = 0; i < 0x1C0; i++)
		{
			wram1[0x1E40+i] = play_prg1[i];
		}
		wram1[0x1E40+0x09E] = mmc_getinfo()->var.prg_beg[0xA]; // INIT_ADR
		wram1[0x1E40+0x09F] = mmc_getinfo()->var.prg_beg[0xB];
		wram1[0x1E40+0x0C4] = mmc_getinfo()->var.prg_beg[0xA]; // INIT_ADR
		wram1[0x1E40+0x0C5] = mmc_getinfo()->var.prg_beg[0xB];
		wram1[0x1E40+0x105] = mmc_getinfo()->var.prg_beg[0xC]; // PLAY_ADR
		wram1[0x1E40+0x106] = mmc_getinfo()->var.prg_beg[0xD];
		wram1[0x1E40+0x0B0] = mmc_getinfo()->var.prg_beg[0x6]; // MAX_SONG
		wram2[0x7FFA] = 0x0E;
		wram2[0x7FFB] = 0x7F;
		wram2[0x7FFC] = 0x40;
		wram2[0x7FFD] = 0x7E;
		wram2[0x7FFE] = 0x0E;
		wram2[0x7FFF] = 0x7F;
	}

	printf("ns %d ss %d\n",mmc_getinfo()->var.prg_beg[0x6],mmc_getinfo()->var.prg_beg[0x7]);
}


static void mapNSF_Reset()
{
	uint8 i;
	uint32 j;
	uint8 bank_switch = 0;

	// Init ExSound
	chip_type = (mmc_getinfo()->var.prg_beg[0x7B]) & 0x3F;
	//parent_NES->apu->SelectExSound(chip_type);
	//exsound apu_setexchip(chip_type);

	//parent_NES->MemoryWrite(0x4015, 0x1f);	

	// Init Banks

	for(i = 0; i < 8; i++)
	{
		bank_switch |= mmc_getinfo()->var.prg_beg[0x70+i];
	}
	if(bank_switch)
	{
		uint8 start_bank = mmc_getinfo()->var.prg_beg[0x9] >> 4;
		for(i = 0; (start_bank + i) < 8; i++)
		{
			mapNSF_BankSwitch(start_bank+i, i);
		}
		for(i = 0; i < 8; i++)
		{
			mapNSF_BankSwitch(i+8, mmc_getinfo()->var.prg_beg[0x70+i]);
		}
		if(chip_type & 4)
		{
			mapNSF_BankSwitch(6, mmc_getinfo()->var.prg_beg[0x76]);
			mapNSF_BankSwitch(7, mmc_getinfo()->var.prg_beg[0x77]);
		}
	}
	else
	{
		uint32 nsf_size = mmc_getinfo()->var.prg_beg[0x0] | (mmc_getinfo()->var.prg_beg[0x1]<<8) | (mmc_getinfo()->var.prg_beg[0x2]<<16);
		uint32 load_addr = mmc_getinfo()->var.prg_beg[0x8] | (mmc_getinfo()->var.prg_beg[0x9]<<8);

        printf("s %d lda %x\n",nsf_size,load_addr);

        for(j = 0; j < nsf_size-0x80; j++)
		{
			wram2[(load_addr+j) & 0x7FFF] = mmc_getinfo()->var.prg_beg[j+0x80];
		}
	}

	// Load Player Program
	mapNSF_LoadPlayer();

	// Map WRAM	
	mmc_getinfo()->CPUPageIndex[3]=&wram1[0x0000]; // $6000-$7FFF (FDS)
	mmc_getinfo()->CPUPageIndex[4]=&wram2[0x0000]; // $8000-$9FFF
	mmc_getinfo()->CPUPageIndex[5]=&wram2[0x2000]; // $A000-$7FFF
	mmc_getinfo()->CPUPageIndex[6]=&wram2[0x4000]; // $C000-$7FFF
	mmc_getinfo()->CPUPageIndex[7]=&wram2[0x6000]; // $E000-$7FFF
	#ifdef __asmcpu__   		
   	init_sram(&wram1[0x0000]);
   	set_cpu_bank_full(&wram2[0x0000],&wram2[0x2000],&wram2[0x4000],&wram2[0x6000]);
   	#else
   	//nes6502 uses directly CPUPageIndex...
   	// so jsut calling to have pfast_pc_update if needed
/*   	nes6502_getcontext(&_NEScontext);
   	nes6502_setcontext(&_NEScontext);*/
   	#endif

   	Wr6502(0x4015,0x1f);
}

static void mapNSF_MemoryWriteLow(uint32 addr, uint8 data)
{
	if((addr >= 0x5FF6) && (addr <= 0x5FFF))
	{
		mapNSF_BankSwitch(addr & 0xF, data);
	}
	//parent_NES->apu->ExWrite(addr, data);
	//exsound ex_write(addr,data);
}

static void mapNSF_MemoryWriteSaveRAM(uint32 addr, uint8 data)
{
	if((chip_type & 4) || (addr < 0x7E40) || (addr >= 0x7FF0))
	{
		wram1[addr - 0x6000] = data;
	}
	//parent_NES->apu->ExWrite(addr, data);
	//exsound ex_write(addr,data);
}

static void mapNSF_MemoryWrite(uint32 addr, uint8 data)
{
	if((chip_type & 4) && (addr >= 0xFFF0) && (addr <= 0xFFF2))
	{
		wram2[addr & 0x7FFF] = data;
	}
	//parent_NES->apu->ExWrite(addr, data);
	//exsound ex_write(addr,data);
}

static uint8 mapNSF_MemoryReadLow(uint32 addr)
{
	//return parent_NES->apu->ExRead(addr);
	return 0; //exsound ex_read(addr);
}

/////////////////////////////////////////////////////////////////////


mapintf_t mapNSF_intf =
{
   256, /* mapper number */
   "NSF player", /* mapper name */
   mapNSF_Reset, /* init routine */
   NULL, /* vblank callback */
   NULL, /* hblank callback */
   NULL, /* get state (snss) */
   NULL, /* set state (snss) */   
   mapNSF_MemoryReadLow,  /*Read low*/
   NULL,  /*Read saveram or rom*/
   NULL,  /*Write high regs 0x4000-0x4017*/
   mapNSF_MemoryWriteLow,  /*Write low   0x4018-0x5FFF*/
   mapNSF_MemoryWriteSaveRAM,  /*Write saveram*/
   mapNSF_MemoryWrite,  /*Write rom*/
   NULL,   /*Latch FDFE*/
   NULL,   /*Latch renderscreen*/
   NULL,   /*Latch Address*/
   NULL    /*SetBarcodeValue*/         
};

